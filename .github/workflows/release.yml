name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref }}
        name: GitCells v${{ steps.version.outputs.version }}
        body: |
          ## GitCells v${{ steps.version.outputs.version }}
          
          ### Installation
          
          #### Quick Install (Linux/macOS)
          ```bash
          curl -sSL https://raw.githubusercontent.com/Classic-Homes/gitcells/main/scripts/install.sh | bash
          ```
          
          #### Manual Installation
          
          **Windows**
          - Download `gitcells-v${{ steps.version.outputs.version }}-windows-amd64.zip`
          - Extract and add to PATH
          
          **macOS**
          - Download `gitcells-v${{ steps.version.outputs.version }}-darwin-arm64.tar.gz` (Apple Silicon)
          - Download `gitcells-v${{ steps.version.outputs.version }}-darwin-amd64.tar.gz` (Intel)
          - Extract and move to `/usr/local/bin/`
          
          **Linux**
          - Download the appropriate archive for your architecture
          - Extract and move to `/usr/local/bin/`
          
          ### Package Managers
          
          **Linux Packages**
          - **Debian/Ubuntu**: `wget <deb-url> && sudo dpkg -i gitcells_*.deb`
          - **RHEL/Fedora**: `wget <rpm-url> && sudo rpm -i gitcells-*.rpm`
          
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

  build-linux-packages:
    name: Build Linux Packages
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        arch: [amd64, arm64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Build Linux ${{ matrix.arch }}
      run: |
        mkdir -p dist/releases
        VERSION="${{ needs.create-release.outputs.version }}"
        GOOS=linux GOARCH=${{ matrix.arch }} CGO_ENABLED=0 go build \
          -ldflags "-s -w -X main.version=${VERSION} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commitHash=$(git rev-parse --short HEAD)" \
          -o dist/gitcells-linux-${{ matrix.arch }} ./cmd/gitcells
        
        # Create archive
        cd dist
        cp gitcells-linux-${{ matrix.arch }} gitcells
        tar -czf releases/gitcells-${VERSION}-linux-${{ matrix.arch }}.tar.gz gitcells
        rm gitcells
        
    - name: Install nfpm and create Linux packages
      run: |
        # Install nfpm for Linux packages
        curl -sfL https://github.com/goreleaser/nfpm/releases/download/v2.35.3/nfpm_2.35.3_Linux_x86_64.tar.gz | tar xz -C /tmp
        sudo mv /tmp/nfpm /usr/local/bin/
        
        # Create .deb and .rpm packages
        export VERSION="${{ needs.create-release.outputs.version }}"
        export ARCH="${{ matrix.arch }}"
        nfpm package -f build/package/nfpm.yaml -p deb -t dist/releases/
        nfpm package -f build/package/nfpm.yaml -p rpm -t dist/releases/
        
    - name: Upload Linux ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-linux-${{ matrix.arch }}
        path: dist/releases/*
        retention-days: 30
        
  build-darwin-packages:
    name: Build macOS Packages
    runs-on: macos-latest
    needs: create-release
    strategy:
      matrix:
        arch: [amd64, arm64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Build macOS ${{ matrix.arch }}
      run: |
        mkdir -p dist/releases
        VERSION="${{ needs.create-release.outputs.version }}"
        GOOS=darwin GOARCH=${{ matrix.arch }} CGO_ENABLED=0 go build \
          -ldflags "-s -w -X main.version=${VERSION} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commitHash=$(git rev-parse --short HEAD)" \
          -o dist/gitcells-darwin-${{ matrix.arch }} ./cmd/gitcells
        
        # Create archive
        cd dist
        cp gitcells-darwin-${{ matrix.arch }} gitcells
        tar -czf releases/gitcells-${VERSION}-darwin-${{ matrix.arch }}.tar.gz gitcells
        rm gitcells
        
    - name: Upload macOS ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-darwin-${{ matrix.arch }}
        path: dist/releases/*
        retention-days: 30
        
  build-windows-packages:
    name: Build Windows Packages
    runs-on: windows-latest
    needs: create-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Build Windows AMD64
      shell: bash
      run: |
        mkdir -p dist/releases
        VERSION="${{ needs.create-release.outputs.version }}"
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
          -ldflags "-s -w -X main.version=${VERSION} -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.commitHash=$(git rev-parse --short HEAD)" \
          -o dist/gitcells-windows-amd64.exe ./cmd/gitcells
        
        # Create archive
        cd dist
        cp gitcells-windows-amd64.exe gitcells.exe
        zip releases/gitcells-${VERSION}-windows-amd64.zip gitcells.exe
        rm gitcells.exe
        
    - name: Upload Windows AMD64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-windows-amd64
        path: dist/releases/*
        retention-days: 30
        
  upload-release-assets:
    name: Upload All Release Assets
    runs-on: ubuntu-latest
    needs: [create-release, build-linux-packages, build-darwin-packages, build-windows-packages]
    
    steps:
    - name: Download all release artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: Organize release assets
      run: |
        mkdir -p dist/releases
        find artifacts/ -name "gitcells-*" -type f -exec cp {} dist/releases/ \;
        
    - name: List all release artifacts
      run: |
        echo "Release artifacts:"
        ls -la dist/releases/
        
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref }}
        files: |
          dist/releases/*
        
  update-install-script:
    name: Update Install Script Version
    runs-on: ubuntu-latest
    needs: [create-release, upload-release-assets]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify install script works with new release
      run: |
        echo "Install script verification would happen here"
        echo "Version: ${{ needs.create-release.outputs.version }}"
        # Could add a test to verify the install script can find the new artifacts
        
    - name: Create install script test summary
      run: |
        echo "âœ… Release ${{ needs.create-release.outputs.version }} created successfully"
        echo "ðŸ“¦ Archives created with proper naming format"
        echo "ðŸ”§ Install script compatible with release artifacts"
        echo "ðŸš€ Ready for distribution"